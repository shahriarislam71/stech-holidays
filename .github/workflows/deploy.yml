name: üöÄ Build, Push & Deploy to VPS

on:
  push:
    branches: [production]  # Your current branch is "production"
  workflow_dispatch:

env:
  # Docker configuration
  REGISTRY: docker.io
  BACKEND_IMAGE_NAME: stech-holidays-backend      # ‚Üê Changed
  FRONTEND_IMAGE_NAME: stech-holidays-frontend    # ‚Üê Changed
  
  # VPS configuration
  VPS_HOST: 72.62.79.113
  VPS_PORT: 2222
  VPS_USER: abdullah
  VPS_PROJECT_ROOT: /opt/stech-holidays           # ‚Üê Changed
  VPS_COMPOSE_DIR: /opt/stech-holidays/compose    # ‚Üê Changed
  VPS_ENV_FILE: /opt/stech-holidays/compose/.env  # ‚Üê Changed

jobs:
  build-backend:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.generate-tag.outputs.tag }}
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PAT }}

      - name: üè∑Ô∏è Generate Docker image tag
        id: generate-tag
        run: |
          TAG=${GITHUB_SHA:0:8}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "üìù Generated tag: $TAG"

      - name: üê≥ Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ steps.generate-tag.outputs.tag }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    runs-on: ubuntu-latest
    needs: build-backend
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PAT }}

      - name: üê≥ Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ needs.build-backend.outputs.image_tag }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL || 'https://api.stechholidays.com' }}
            NEXT_PUBLIC_APP_URL=${{ vars.NEXT_PUBLIC_APP_URL || 'https://stechholidays.com' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-vps:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: success()
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up SSH connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          ssh-keyscan -p ${{ env.VPS_PORT }} ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "üîë SSH key saved. Testing connection..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ env.VPS_PORT }} \
              -o ConnectTimeout=10 \
              -o StrictHostKeyChecking=no \
              ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
              "echo '‚úÖ SSH connection successful' && docker compose version"

      - name: üì§ Create deployment script
        run: |
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "========================================"
          echo "üöÄ DEPLOYING TO VPS"
          echo "========================================"
          echo "Project: stech-holidays"                  # ‚Üê Changed
          echo "New Tag: $IMAGE_TAG"
          echo "Env file: $VPS_ENV_FILE"
          echo ""
          
          # Navigate to compose directory
          cd $VPS_COMPOSE_DIR
          
          echo "1Ô∏è‚É£ Pulling new Docker images..."
          
          echo "üì• Pulling backend: $BACKEND_IMAGE_FULL"
          docker pull $BACKEND_IMAGE_FULL
          
          echo "üì• Pulling frontend: $FRONTEND_IMAGE_FULL"
          docker pull $FRONTEND_IMAGE_FULL
          
          echo "‚úÖ Images pulled successfully"
          
          # Update .env file with new image tags
          echo ""
          echo "2Ô∏è‚É£ Updating .env file with new image tags..."
          
          # Check if .env file exists
          if [ ! -f "$VPS_ENV_FILE" ]; then
            echo "‚ùå ERROR: .env file not found at $VPS_ENV_FILE"
            exit 1
          fi
          
          # Backup current .env file
          cp $VPS_ENV_FILE $VPS_ENV_FILE.backup.$(date +%Y%m%d_%H%M%S)
          
          # Update backend image tag (preserving all other variables)
          sed -i "s|^BACKEND_IMAGE=.*|BACKEND_IMAGE=$BACKEND_IMAGE_FULL|" $VPS_ENV_FILE
          
          # Update frontend image tag (preserving all other variables)
          sed -i "s|^FRONTEND_IMAGE=.*|FRONTEND_IMAGE=$FRONTEND_IMAGE_FULL|" $VPS_ENV_FILE
          
          echo "‚úÖ .env file updated"
          echo "New backend image: $BACKEND_IMAGE_FULL"
          echo "New frontend image: $FRONTEND_IMAGE_FULL"
          
          # Restart services
          echo ""
          echo "3Ô∏è‚É£ Restarting services with new images..."
          
          # Stop and remove old containers
          echo "üõë Stopping existing containers..."
          docker compose down
          
          # Start new containers
          echo "üöÄ Starting containers with new images..."
          docker compose up -d
          
          echo "‚úÖ Services restarted"
          
          # Verify deployment
          echo ""
          echo "4Ô∏è‚É£ Verifying deployment..."
          sleep 10
          
          echo "üìä Checking container status:"
          docker compose ps
          
          echo ""
          echo "üåê Testing services..."
          if curl -s http://localhost:8000 > /dev/null; then
              echo "‚úÖ Backend is responding"
          else
              echo "‚ùå Backend may not be running"
          fi
          
          if curl -s http://localhost:3000 > /dev/null; then
              echo "‚úÖ Frontend is responding"
          else
              echo "‚ùå Frontend may not be running"
          fi
          
          # Check logs
          echo ""
          echo "üìù Checking recent logs..."
          echo "Backend logs (last 5 lines):"
          docker compose logs backend --tail 5 2>/dev/null || echo "No backend logs yet"
          
          echo ""
          echo "Frontend logs (last 5 lines):"
          docker compose logs frontend --tail 5 2>/dev/null || echo "No frontend logs yet"
          
          # Deployment summary
          echo ""
          echo "========================================"
          echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "========================================"
          echo ""
          echo "üìã DEPLOYMENT SUMMARY:"
          echo "‚Ä¢ Backend: $BACKEND_IMAGE_FULL"
          echo "‚Ä¢ Frontend: $FRONTEND_IMAGE_FULL"
          echo "‚Ä¢ Updated: $VPS_ENV_FILE"
          echo "‚Ä¢ Commit: $COMMIT_SHA"
          echo "‚Ä¢ Time: $(date)"
          echo ""
          echo "üîç Current .env image settings:"
          grep "^BACKEND_IMAGE\|^FRONTEND_IMAGE" $VPS_ENV_FILE
          echo ""
          echo "========================================"
          EOF
          
          chmod +x deploy.sh
          echo "‚úÖ Deployment script created"

      - name: üì§ Copy deployment script to VPS
        run: |
          echo "üì§ Copying deployment script to VPS..."
          scp -i ~/.ssh/deploy_key \
              -P ${{ env.VPS_PORT }} \
              -o StrictHostKeyChecking=no \
              deploy.sh \
              ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/deploy.sh

      - name: ‚ö° Execute deployment on VPS
        env:
          BACKEND_IMAGE_FULL: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ needs.build-backend.outputs.image_tag }}
          FRONTEND_IMAGE_FULL: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ needs.build-backend.outputs.image_tag }}
          IMAGE_TAG: ${{ needs.build-backend.outputs.image_tag }}
          COMMIT_SHA: ${{ github.sha }}
          VPS_HOST: ${{ env.VPS_HOST }}
          VPS_USER: ${{ env.VPS_USER }}
          VPS_COMPOSE_DIR: ${{ env.VPS_COMPOSE_DIR }}
          VPS_ENV_FILE: ${{ env.VPS_ENV_FILE }}
        run: |
          echo "‚ö° Executing deployment on VPS..."
          echo "Backend: $BACKEND_IMAGE_FULL"
          echo "Frontend: $FRONTEND_IMAGE_FULL"
          echo "Env file: $VPS_ENV_FILE"
          
          ssh -i ~/.ssh/deploy_key \
              -p ${{ env.VPS_PORT }} \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              ${{ env.VPS_USER }}@${{ env.VPS_HOST }} \
              "BACKEND_IMAGE_FULL='$BACKEND_IMAGE_FULL' \
               FRONTEND_IMAGE_FULL='$FRONTEND_IMAGE_FULL' \
               IMAGE_TAG='$IMAGE_TAG' \
               COMMIT_SHA='$COMMIT_SHA' \
               VPS_COMPOSE_DIR='$VPS_COMPOSE_DIR' \
               VPS_ENV_FILE='$VPS_ENV_FILE' \
               bash /tmp/deploy.sh"

      - name: ‚úÖ Verify deployment
        run: |
          echo "üîç Verifying deployment on VPS..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ env.VPS_PORT }} \
              -o StrictHostKeyChecking=no \
              ${{ env.VPS_USER }}@${{ env.VPS_HOST }} << 'EOF'
            echo "üìä Current containers:"
            cd ${{ env.VPS_COMPOSE_DIR }}
            docker compose ps
            
            echo ""
            echo "üìù Current .env file image settings:"
            grep "^BACKEND_IMAGE\|^FRONTEND_IMAGE" ${{ env.VPS_ENV_FILE }}
            
            echo ""
            echo "üê≥ Current running images:"
            docker compose images
            
            echo ""
            echo "üìÑ Full .env file location:"
            ls -la ${{ env.VPS_ENV_FILE }}
            
            echo ""
            echo "‚úÖ Deployment verification complete!"
          EOF

      - name: üìù Deployment summary
        run: |
          echo "========================================"
          echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "========================================"
          echo "üì¶ Deployed Images:"
          echo "Backend: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ needs.build-backend.outputs.image_tag }}"
          echo "Frontend: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ needs.build-backend.outputs.image_tag }}"
          echo ""
          echo "üìç VPS Details:"
          echo "Host: ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.VPS_PORT }}"
          echo "Compose directory: ${{ env.VPS_COMPOSE_DIR }}"
          echo "Env file: ${{ env.VPS_ENV_FILE }}"
          echo ""
          echo "üîÑ Actions performed:"
          echo "  1. Pulled new Docker images"
          echo "  2. Updated ${{ env.VPS_ENV_FILE }} with new tags"
          echo "  3. Restarted containers with new images"
          echo ""
          echo "üîç Check deployment:"
          echo "  ssh -p ${{ env.VPS_PORT }} ${{ env.VPS_USER }}@${{ env.VPS_HOST }}"
          echo "  grep '^BACKEND_IMAGE\|^FRONTEND_IMAGE' ${{ env.VPS_ENV_FILE }}"
          echo "  cd ${{ env.VPS_COMPOSE_DIR }} && docker compose ps"
          echo ""
          echo "üïê Deployment timestamp: $(date)"
          echo "========================================"
          
          echo "::notice title=Deployment Successful::‚úÖ Application deployed to VPS successfully!"